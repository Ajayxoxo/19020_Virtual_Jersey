<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Virtual Try-On</title>
    <!-- Use Tailwind CSS for a modern and responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use the Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        video {
            -webkit-transform: scaleX(-1);
            transform: scaleX(-1);
        }
    </style>
    <!-- JSEncrypt library for RSA encryption, needed for authentication -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col items-center justify-center p-4 transition-colors duration-300">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-4xl text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-500 to-pink-500 mb-4">
            AI Virtual Try-On
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mb-6">
            Use your camera to take a photo and try on a jersey!
        </p>
        
        <!-- Main Application Container -->
        <div id="app-container">
            <!-- Camera and Controls (Initial View) -->
            <div id="camera-view" class="flex flex-col items-center">
                <div class="relative w-full max-w-md h-72 sm:h-96">
                    <video id="camera-feed" class="w-full h-full object-cover rounded-xl shadow-inner border-4 border-dashed border-gray-300 dark:border-gray-600" autoplay playsinline></video>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2 mt-4 w-full max-w-md">
                    <button id="capture-button" class="w-full sm:w-1/2 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors duration-200" disabled>
                        <span id="capture-text">Take Photo</span>
                    </button>
                    <select id="camera-select" class="w-full sm:w-1/2 px-4 py-2 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg shadow-md border border-gray-300 dark:border-gray-600 cursor-pointer disabled:bg-gray-200 disabled:dark:bg-gray-600 disabled:cursor-not-allowed">
                    </select>
                </div>
            </div>

            <!-- Photo Preview and Controls (After Photo is Taken) -->
            <div id="photo-preview-view" class="flex flex-col sm:flex-row justify-around items-center gap-6 mb-8 hidden">
                <div class="flex flex-col items-center">
                    <div class="relative w-full max-w-md h-72 sm:h-96">
                        <canvas id="photo-canvas" class="w-full h-full object-cover rounded-xl shadow-inner border-4 border-solid border-purple-400"></canvas>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center gap-2 mt-4 w-full max-w-md">
                        <button id="retake-button" class="w-full sm:w-1/2 px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors duration-200">
                            Retake Photo
                        </button>
                        <button id="try-on-button" class="w-full sm:w-1/2 px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 focus:outline-none focus:ring-4 focus:ring-purple-300 transition-all duration-300 transform hover:scale-105 active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center">
                            <span id="button-text">Try On Now</span>
                            <div id="spinner" class="hidden animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent ml-2"></div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Result Container (After Processing) -->
            <div id="result-view" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">Your Virtual Try-On Result</h2>
                <div id="tryon-result" class="w-full h-80 bg-gray-200 dark:bg-gray-700 rounded-xl flex items-center justify-center shadow-inner overflow-hidden">
                    <p class="text-gray-500 dark:text-gray-400 text-lg">Your result will appear here.</p>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2 mt-4 w-full justify-center">
                    <button id="download-button" class="px-6 py-2 bg-green-500 text-white font-semibold rounded-full shadow-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-300 transform hover:scale-105 active:scale-95">
                        Download Result
                    </button>
                    <button id="home-button" class="px-6 py-2 bg-gray-500 text-white font-semibold rounded-full shadow-lg hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all duration-300 transform hover:scale-105 active:scale-95">
                        Go to Home
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for messages -->
    <div id="modal" class="modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-2xl w-96 text-center">
            <h3 id="modal-title" class="text-lg font-semibold mb-3"></h3>
            <p id="modal-message" class="text-gray-600 dark:text-gray-400 mb-6"></p>
            <button onclick="closeModal()" class="w-full px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">Close</button>
        </div>
    </div>

    <!-- API Keys -->
    <script src="config.js"></script>
    <script>
        // DOM Elements
        const cameraFeed = document.getElementById('camera-feed');
        const photoCanvas = document.getElementById('photo-canvas');
        const captureButton = document.getElementById('capture-button');
        const retakeButton = document.getElementById('retake-button');
        const tryOnButton = document.getElementById('try-on-button');
        const downloadButton = document.getElementById('download-button');
        const homeButton = document.getElementById('home-button');
        const cameraSelect = document.getElementById('camera-select');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        const tryonResult = document.getElementById('tryon-result');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');

        const cameraView = document.getElementById('camera-view');
        const photoPreviewView = document.getElementById('photo-preview-view');
        const resultView = document.getElementById('result-view');
        
        // Constants and State
        const API_SERVER = 'https://yce-api-01.perfectcorp.com';
        const POLL_INTERVAL = 1000;
        let userImageFile = null;
        let jerseyImageFile = null;
        let resultImageURL = null;
        let stream = null;

        // Modal Functions
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
        }

        // Camera Functions
        async function initCamera(deviceId) {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                showModal('Security Error', 'Camera access requires a secure connection (HTTPS or localhost). Please run a local web server to use this feature.');
                return;
            }

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    facingMode: 'user',
                    deviceId: deviceId ? { exact: deviceId } : undefined
                }
            };
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = stream;
                captureButton.disabled = false;
            } catch (err) {
                showModal('Camera Error', 'Could not access the camera. Please ensure you have given permission. Error: ' + err.message);
                captureButton.disabled = true;
            }
        }

        async function listCameras() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                showModal('Security Error', 'Camera access requires a secure connection (HTTPS or localhost). Please run a local web server to use this feature.');
                return;
            }

            cameraSelect.innerHTML = '';
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                if (videoDevices.length > 0) {
                    videoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `Camera ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                    initCamera(videoDevices[0].deviceId);
                } else {
                    showModal('Camera Error', 'No camera devices found.');
                    captureButton.disabled = true;
                }
            } catch (err) {
                showModal('Device Error', 'Could not list camera devices. Error: ' + err.message);
                captureButton.disabled = true;
            }
        }
        
        function takePhoto() {
            const context = photoCanvas.getContext('2d');
            photoCanvas.width = cameraFeed.videoWidth;
            photoCanvas.height = cameraFeed.videoHeight;
            context.drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);
            
            // Switch views
            cameraView.classList.add('hidden');
            photoPreviewView.classList.remove('hidden');

            // Stop the camera stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Convert canvas content to a file
            photoCanvas.toBlob(blob => {
                if (blob) {
                    userImageFile = new File([blob], 'user-photo.png', { type: 'image/png' });
                } else {
                    showModal('Capture Error', 'Failed to capture image from canvas.');
                }
            }, 'image/png');
        }

        function retakePhoto() {
            // Switch views
            photoPreviewView.classList.add('hidden');
            cameraView.classList.remove('hidden');
            resultView.classList.add('hidden');
            
            userImageFile = null;
            resultImageURL = null;
            tryonResult.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-lg">Your result will appear here.</p>`;

            // Restart the camera
            listCameras();
        }

        function downloadResult() {
            if (resultImageURL) {
                const link = document.createElement('a');
                link.href = resultImageURL;
                link.download = 'virtual-tryon-result.jpg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // API Call Functions
        async function getJerseyImageFile() {
            try {
                const response = await fetch('Jersey.png');
                if (!response.ok) {
                    throw new Error('Failed to load Jersey.png. Make sure the file exists in the same directory and you are running a local server.');
                }
                const blob = await response.blob();
                jerseyImageFile = new File([blob], 'Jersey.png', { type: blob.type });
            } catch (error) {
                showModal('Error', error.message);
                throw error;
            }
        }

        // API interaction functions
        async function uploadFileToPresignedUrl(url, headers, file) {
            return fetch(url, {
                method: 'PUT',
                headers: {
                    ...headers,
                    'Content-Length': file.size
                },
                body: file
            });
        }

        async function authenticateAndRunTask() {
            tryOnButton.disabled = true;
            buttonText.textContent = 'Processing...';
            spinner.classList.remove('hidden');
            tryonResult.innerHTML = `<div class="flex items-center justify-center p-4">
                                         <div class="animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent"></div>
                                     </div>
                                     <p class="text-gray-500 dark:text-gray-400 mt-4">Please wait, this may take a moment...</p>`;
            
            if (typeof API_KEY === 'undefined' || typeof SECRET_KEY === 'undefined' || API_KEY === 'YOUR_API_KEY' || SECRET_KEY === 'YOUR_SECRET_KEY') {
                showModal('Authentication Error', 'API keys are not set. Please open config.js and add your keys.');
                resetButton();
                return;
            }

            try {
                // Step 1: Generate id_token
                const jse = new JSEncrypt();
                jse.setPublicKey(SECRET_KEY);
                const encrypted = jse.encrypt(`client_id=${API_KEY}&timestamp=${new Date().getTime()}`);
                if (!encrypted) {
                    throw new Error('Failed to encrypt with the provided secret key. Please check your secret key.');
                }
                const idToken = encrypted;
                
                // Step 2: Authenticate and get access_token
                const authResponse = await fetch(`${API_SERVER}/s2s/v1.0/client/auth`, {
                    method: 'POST',
                    headers: {'content-type': 'application/json'},
                    body: JSON.stringify({
                        client_id: API_KEY,
                        id_token: idToken
                    })
                });
                const authData = await authResponse.json();
                if (authData.status !== 200) {
                    throw new Error(`Authentication failed: ${authData.error_code}`);
                }
                const accessToken = authData.result.access_token;
                
                await getJerseyImageFile();

                // Step 3: Get upload URLs for both files
                const fileResponse = await fetch(`${API_SERVER}/s2s/v1.1/file/cloth`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: [
                            {content_type: userImageFile.type, file_name: userImageFile.name, file_size: userImageFile.size},
                            {content_type: jerseyImageFile.type, file_name: jerseyImageFile.name, file_size: jerseyImageFile.size}
                        ]
                    })
                });
                const fileData = await fileResponse.json();
                if (fileData.status !== 200) {
                    throw new Error(`File upload request failed: ${fileData.error_code}`);
                }
                const userFile = fileData.result.files.find(f => f.file_name === userImageFile.name);
                const clothingFile = fileData.result.files.find(f => f.file_name === jerseyImageFile.name);
                
                await Promise.all([
                    uploadFileToPresignedUrl(userFile.requests[0].url, userFile.requests[0].headers, userImageFile),
                    uploadFileToPresignedUrl(clothingFile.requests[0].url, clothingFile.requests[0].headers, jerseyImageFile)
                ]);

                // Step 4: Run the AI try-on task
                const runTaskResponse = await fetch(`${API_SERVER}/s2s/v1.0/task/cloth`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'content-type': 'application/json'
                    },
                    body: JSON.stringify({
                        request_id: Math.floor(Math.random() * 1000000),
                        payload: {
                            file_sets: {
                                src_ids: [userFile.file_id],
                                ref_ids: [clothingFile.file_id]
                            },
                            actions: [
                                {
                                    id: 0,
                                    params: {
                                        garment_category: 'upper_body'
                                    }
                                }
                            ]
                        }
                    })
                });
                const runTaskData = await runTaskResponse.json();
                if (runTaskData.status !== 200) {
                    throw new Error(`Try-on task failed to start: ${runTaskData.error_code}`);
                }
                const taskId = runTaskData.result.task_id;

                // Step 5: Poll for results
                let taskStatus = 'running';
                while (taskStatus === 'running') {
                    await new Promise(resolve => setTimeout(resolve, POLL_INTERVAL));
                    const statusResponse = await fetch(`${API_SERVER}/s2s/v1.0/task/cloth?task_id=${taskId}`, {
                        headers: {'Authorization': `Bearer ${accessToken}`}
                    });
                    const statusData = await statusResponse.json();

                    if (statusData.status === 200) {
                        taskStatus = statusData.result.status;
                        if (taskStatus === 'success') {
                            resultImageURL = statusData.result.results[0].data[0].url;
                            break;
                        } else if (taskStatus === 'error') {
                            throw new Error(`Try-on task failed: ${statusData.result.error}`);
                        }
                    } else {
                        throw new Error(`Failed to check task status: ${statusData.error_code}`);
                    }
                }

                // Step 6: Display the final result
                photoPreviewView.classList.add('hidden');
                resultView.classList.remove('hidden');
                tryonResult.innerHTML = `<img src="${resultImageURL}" alt="Virtual Try-On Result" class="w-full h-full object-contain rounded-xl">`;
                downloadButton.classList.remove('hidden');

            } catch (error) {
                showModal('Try-On Error', error.message);
            }
            
            resetButton();
        }

        // Event Listeners
        cameraSelect.addEventListener('change', (event) => {
            initCamera(event.target.value);
        });
        captureButton.addEventListener('click', takePhoto);
        retakeButton.addEventListener('click', retakePhoto);
        homeButton.addEventListener('click', retakePhoto);
        downloadButton.addEventListener('click', downloadResult);
        tryOnButton.addEventListener('click', authenticateAndRunTask);

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            listCameras();
        });
    </script>
</body>
</html>
